name: GitHub Environment Sync & Deploy

on:
  push:
    branches: [ main ]
    paths:
      - '.env.local.template'
      - '.env.example'
      - 'scripts/automated-env-sync.js'
      - 'src/**'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  validate-environment:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    outputs:
      validation-passed: ${{ steps.validate.outputs.valid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Validate environment configuration
        id: validate
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_SUPABASE_FUNCTIONS_URL: ${{ secrets.VITE_SUPABASE_FUNCTIONS_URL }}
          VITE_RESEND_API_KEY: ${{ secrets.VITE_RESEND_API_KEY }}
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
        run: |
          echo "ğŸ” Running environment validation..."
          MISSING=()

          for key in \
            VITE_SUPABASE_URL \
            VITE_SUPABASE_ANON_KEY \
            VITE_SUPABASE_FUNCTIONS_URL \
            VITE_RESEND_API_KEY \
            VITE_GOOGLE_MAPS_API_KEY \
            VITE_STRIPE_PUBLISHABLE_KEY; do

            if [ -z "${!key}" ]; then
              echo "âŒ Missing env var: $key"
              MISSING+=("$key")
            else
              echo "âœ… Found: $key"
            fi
          done

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "âš ï¸ Missing environment variables: ${MISSING[*]}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… All required environment variables are present."
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    name: Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: validate-environment
    if: needs.validate-environment.outputs.validation-passed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create .env.local from secrets
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env.local
          echo "VITE_SUPABASE_FUNCTIONS_URL=${{ secrets.VITE_SUPABASE_FUNCTIONS_URL }}" >> .env.local
          echo "VITE_RESEND_API_KEY=${{ secrets.VITE_RESEND_API_KEY }}" >> .env.local
          echo "VITE_GOOGLE_MAPS_API_KEY=${{ secrets.VITE_GOOGLE_MAPS_API_KEY }}" >> .env.local
          echo "VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}" >> .env.local
          echo "âœ… .env.local created successfully"

      - name: Build project
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          commit_message: "ğŸš€ Auto-deploy from GitHub Actions"

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ View live site at: https://greenscapelux.com"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Notify in logs
        run: echo "ğŸš¨ Workflow failed. Check the Actions tab for details."
