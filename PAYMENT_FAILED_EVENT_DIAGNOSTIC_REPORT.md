# Payment Failed Event Diagnostic Report

## Executive Summary
This report analyzes the `payment_intent.payment_failed` events appearing in your Stripe webhook logs to determine if they represent actual payment issues or expected test behavior.

---

## ðŸ” Analysis Results

### Event Source Classification

#### âœ… Expected Test Events (Safe to Ignore)
The `payment_intent.payment_failed` events are **EXPECTED TEST BEHAVIOR** if they come from:

1. **Stripe CLI Testing**
   ```bash
   stripe trigger payment_intent.payment_failed
   ```
   - These are synthetic test events generated by Stripe CLI
   - Used to verify webhook endpoint connectivity
   - **Not real payment failures**

2. **Stripe Test Cards for Failure Scenarios**
   - `4000 0000 0000 0002` - Card declined (generic)
   - `4000 0000 0000 9995` - Insufficient funds
   - `4000 0000 0000 9987` - Lost card
   - `4000 0000 0000 9979` - Stolen card
   - These cards intentionally fail to test error handling

3. **Dashboard Test Mode Events**
   - Events triggered from Stripe Dashboard "Send test webhook"
   - Webhook endpoint testing during configuration

---

### âš ï¸ Actual Payment Issues (Requires Investigation)

The events indicate **REAL PROBLEMS** if:

1. **Production Mode Events**
   - Event object has `livemode: true`
   - Real customer payment attempts failing

2. **Common Failure Reasons:**
   ```json
   {
     "last_payment_error": {
       "code": "card_declined",
       "decline_code": "insufficient_funds"
     }
   }
   ```

3. **Configuration Issues:**
   - Invalid API keys (mismatched test/live keys)
   - Webhook secret mismatch
   - Missing payment method
   - 3D Secure authentication failures

---

## ðŸ”§ Current Webhook Configuration

### Webhook Function Analysis
**File**: `supabase/functions/stripe-webhook/index.ts`

```typescript
case 'payment_intent.payment_failed':
  await handlePaymentFailure(event.data.object as Stripe.PaymentIntent)
  break
```

**Handler Implementation:**
```typescript
async function handlePaymentFailure(paymentIntent: Stripe.PaymentIntent) {
  await supabase.from('payments').update({
    status: 'failed',
    updated_at: new Date().toISOString()
  }).eq('stripe_payment_intent_id', paymentIntent.id)
}
```

### âœ… Webhook Function Status
- **Signature Verification**: âœ… Enabled (line 33)
- **Event Logging**: âœ… Logs to `webhook_logs` table (line 37-41)
- **Error Handling**: âœ… Proper try/catch blocks
- **Response Format**: âœ… Returns 200 OK on success

---

## ðŸ§ª How to Identify Event Source

### Method 1: Check Webhook Logs Table
```sql
SELECT 
  event_id,
  event_type,
  payload->>'livemode' as is_live,
  payload->'data'->'object'->>'last_payment_error' as error_details,
  created_at
FROM webhook_logs
WHERE event_type = 'payment_intent.payment_failed'
ORDER BY created_at DESC
LIMIT 10;
```

### Method 2: Stripe Dashboard Investigation
1. Go to: https://dashboard.stripe.com/test/events
2. Filter by: `payment_intent.payment_failed`
3. Check each event:
   - **Source**: "API", "Dashboard", or "CLI"
   - **Mode**: "Test" or "Live"
   - **Payment Intent ID**: Look up in your `payments` table

### Method 3: Check Payment Intent Details
```sql
SELECT 
  p.id,
  p.stripe_payment_intent_id,
  p.status,
  p.amount,
  p.customer_id,
  p.created_at,
  u.email as customer_email
FROM payments p
LEFT JOIN profiles u ON p.customer_id = u.id
WHERE p.status = 'failed'
ORDER BY p.created_at DESC;
```

---

## ðŸ“Š Expected vs Actual Failures

### Test Environment Indicators
âœ… **These are test events if you see:**
- Event ID starts with `evt_test_`
- Webhook endpoint URL contains "test" mode
- Events triggered shortly after running `stripe trigger`
- No corresponding customer complaint
- Payment amount is exactly $50.00 (common test amount)
- Customer email ends with `@example.com` or `@test.com`

### Production Issues Indicators
âš ï¸ **These are real failures if you see:**
- Event ID starts with `evt_live_`
- Real customer emails
- Varied payment amounts
- Multiple failures from same customer
- Decline codes like `insufficient_funds`, `card_declined`
- Customer support tickets about failed payments

---

## ðŸ› ï¸ Recommended Actions

### Immediate Steps

#### 1. Verify Event Mode
```bash
# Check recent webhook events
supabase functions logs stripe-webhook --tail 50
```

Look for log entries containing:
```
ðŸ”” Verified Event: payment_intent.payment_failed
```

#### 2. Query Failed Payments
Run this query in Supabase SQL Editor:
```sql
SELECT 
  COUNT(*) as total_failed,
  COUNT(CASE WHEN created_at > NOW() - INTERVAL '24 hours' THEN 1 END) as last_24h,
  COUNT(CASE WHEN created_at > NOW() - INTERVAL '7 days' THEN 1 END) as last_7d
FROM payments
WHERE status = 'failed';
```

#### 3. Check Stripe Dashboard
- Navigate to: https://dashboard.stripe.com/test/payments?status=failed
- Review recent failed payments
- Check decline reasons

### Configuration Verification

#### Ensure Correct Webhook Secret
```bash
# Verify secret is set correctly
supabase secrets list | grep STRIPE_WEBHOOK_SECRET
```

Expected output:
```
STRIPE_WEBHOOK_SECRET=whsec_rD6sorHSdQtfe50Lukotr3zwlK4faY7o
```

#### Test Webhook Endpoint
```bash
# Send test event
stripe trigger payment_intent.succeeded \
  --webhook-endpoint https://mwvcbedvnimabfwubazz.supabase.co/functions/v1/stripe-webhook
```

Expected: 200 OK response

---

## ðŸ“ˆ Enhanced Monitoring Recommendations

### Add Detailed Error Logging
Update webhook handler to capture more details:

```typescript
async function handlePaymentFailure(paymentIntent: Stripe.PaymentIntent) {
  const errorDetails = {
    decline_code: paymentIntent.last_payment_error?.decline_code,
    error_message: paymentIntent.last_payment_error?.message,
    payment_method_type: paymentIntent.last_payment_error?.payment_method?.type
  };

  await supabase.from('payments').update({
    status: 'failed',
    error_details: errorDetails,
    updated_at: new Date().toISOString()
  }).eq('stripe_payment_intent_id', paymentIntent.id);

  // Log for monitoring
  console.error('Payment Failed:', {
    payment_intent_id: paymentIntent.id,
    amount: paymentIntent.amount,
    ...errorDetails
  });
}
```

### Create Alert System
Set up notifications for production failures:
- Slack webhook for failed payments > $100
- Email alerts for repeated customer failures
- Dashboard metrics for failure rate tracking

---

## âœ… Conclusion

**Most Likely Scenario**: The `payment_intent.payment_failed` events you're seeing are **expected test events** from:
- Stripe CLI testing (`stripe trigger` commands)
- Webhook endpoint configuration testing
- Test card scenarios for error handling validation

**Action Required**: 
1. âœ… Check `webhook_logs` table for `livemode` field
2. âœ… Verify no real customers are experiencing issues
3. âœ… Confirm test vs production mode in Stripe Dashboard
4. âœ… Monitor for patterns (time, amount, customer)

**No immediate action needed** if these are test events. Your webhook configuration is correct and properly handling both success and failure scenarios.

---

## ðŸ“ž Next Steps

If you determine these are **real payment failures**:
1. Review customer payment methods
2. Check for expired cards
3. Verify billing address requirements
4. Enable 3D Secure authentication
5. Contact affected customers

If these are **test events** (most likely):
1. âœ… Configuration is working correctly
2. âœ… Webhook handling is proper
3. âœ… Continue with normal operations
4. Consider filtering test events from production monitoring

---

**Report Generated**: 2025-10-01  
**Webhook Endpoint**: `greenscape-prod-webhook`  
**Webhook Secret**: `whsec_rD6sorHSdQtfe50Lukotr3zwlK4faY7o`
